{% extends "base.html" %}

{% block title %}Browse Events - Northwoods Events{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Browse Events</h2>
        <button onclick="runPipeline()" class="btn btn-secondary">
            üîÑ Refresh Events
        </button>
    </div>
    
    <div class="filters">
        <div class="filter-input">
            <input type="text" 
                   id="keyword-filter" 
                   class="form-control" 
                   placeholder="Search by keyword..."
                   onkeyup="applyFilters()">
        </div>
        <div class="filter-input">
            <select id="source-filter" class="form-control" onchange="applyFilters()">
                <option value="">All Sources</option>
            </select>
        </div>
        <div class="filter-input">
            <input type="text" 
                   id="location-filter" 
                   class="form-control" 
                   placeholder="Filter by location..."
                   onkeyup="applyFilters()">
        </div>
    </div>
    
    <div style="margin-bottom: 1rem; color: var(--text-muted);">
        <span id="event-count">Loading events...</span>
        <span id="selected-count" style="margin-left: 1rem; display: none;"></span>
    </div>
    
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading events...</p>
    </div>
    
    <div id="events-container" style="display: none;">
        <div id="events-grid" class="grid grid-3"></div>
    </div>
</div>

<div id="selection-panel" style="position: fixed; bottom: 20px; right: 20px; display: none;">
    <div class="card" style="min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
        <h3 style="margin-bottom: 1rem;">Selected Events</h3>
        <div id="selected-events-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 1rem;">
        </div>
        <button onclick="addToFeed()" class="btn btn-primary" style="width: 100%;">
            Add to Curated Feed
        </button>
        <button onclick="clearSelection()" class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem;">
            Clear Selection
        </button>
    </div>
</div>

<!-- Add to Feed Modal -->
<div id="add-to-feed-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 1rem;">Add Events to Feed</h3>
        <div class="form-group">
            <label class="form-label">Select Feed:</label>
            <select id="feed-select" class="form-control">
                <option value="">Loading feeds...</option>
            </select>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button onclick="confirmAddToFeed()" class="btn btn-primary" style="flex: 1;">
                Add to Feed
            </button>
            <button onclick="closeAddToFeedModal()" class="btn btn-secondary" style="flex: 1;">
                Cancel
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allEvents = [];
let filteredEvents = [];
let selectedEvents = new Set();
let sources = [];
let feeds = [];

async function loadData() {
    try {
        // Load events
        const eventsResult = await API.get('/api/events');
        allEvents = eventsResult.events || [];
        filteredEvents = [...allEvents];
        
        // Load sources
        const sourcesResult = await API.get('/api/sources');
        sources = sourcesResult.sources || [];
        
        // Load feeds
        const feedsResult = await API.get('/api/feeds');
        feeds = feedsResult.feeds || [];
        
        populateSourceFilter();
        populateFeedSelect();
        renderEvents();
    } catch (error) {
        console.error('Error loading data:', error);
        showToast('Failed to load events', 'danger');
    } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('events-container').style.display = 'block';
    }
}

function populateSourceFilter() {
    const select = document.getElementById('source-filter');
    const uniqueSources = [...new Set(allEvents.map(e => e.source).filter(Boolean))];
    
    select.innerHTML = '<option value="">All Sources</option>' +
        uniqueSources.map(source => `<option value="${escapeHtml(source)}">${escapeHtml(source)}</option>`).join('');
}

function populateFeedSelect() {
    const select = document.getElementById('feed-select');
    const enabledFeeds = feeds.filter(f => f.enabled);
    
    if (enabledFeeds.length === 0) {
        select.innerHTML = '<option value="">No enabled feeds available</option>';
    } else {
        select.innerHTML = enabledFeeds.map(feed => 
            `<option value="${feed.id}">${escapeHtml(feed.name)}</option>`
        ).join('');
    }
}

function applyFilters() {
    const keyword = document.getElementById('keyword-filter').value.toLowerCase();
    const source = document.getElementById('source-filter').value.toLowerCase();
    const location = document.getElementById('location-filter').value.toLowerCase();
    
    filteredEvents = allEvents.filter(event => {
        const matchesKeyword = !keyword || 
            (event.title || '').toLowerCase().includes(keyword) ||
            (event.location || '').toLowerCase().includes(keyword);
        
        const matchesSource = !source || 
            (event.source || '').toLowerCase().includes(source);
        
        const matchesLocation = !location ||
            (event.location || '').toLowerCase().includes(location);
        
        return matchesKeyword && matchesSource && matchesLocation;
    });
    
    renderEvents();
}

function renderEvents() {
    const container = document.getElementById('events-grid');
    const countEl = document.getElementById('event-count');
    
    countEl.textContent = `Showing ${filteredEvents.length} of ${allEvents.length} events`;
    
    if (filteredEvents.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No events found</p></div>';
        return;
    }
    
    container.innerHTML = filteredEvents.map(event => {
        const isSelected = selectedEvents.has(event.uid);
        return `
            <div class="event-card ${isSelected ? 'selected' : ''}" 
                 onclick="toggleEventSelection('${event.uid}')">
                <h4 class="event-title">${escapeHtml(event.title || 'Untitled')}</h4>
                <div class="event-meta">
                    <div class="event-date">üìÖ ${formatDate(event.start_utc)}</div>
                    ${event.location ? `<div>üìç ${escapeHtml(event.location)}</div>` : ''}
                    <div>üè¢ ${escapeHtml(event.source || 'Unknown')}</div>
                    ${event.uid ? `<div style="font-size: 0.75rem; color: var(--text-muted);">UID: ${event.uid}</div>` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function toggleEventSelection(uid) {
    if (selectedEvents.has(uid)) {
        selectedEvents.delete(uid);
    } else {
        selectedEvents.add(uid);
    }
    updateSelection();
    renderEvents();
}

function updateSelection() {
    const panel = document.getElementById('selection-panel');
    const countEl = document.getElementById('selected-count');
    const listEl = document.getElementById('selected-events-list');
    
    if (selectedEvents.size === 0) {
        panel.style.display = 'none';
        countEl.style.display = 'none';
        return;
    }
    
    panel.style.display = 'block';
    countEl.style.display = 'inline';
    countEl.textContent = `${selectedEvents.size} event(s) selected`;
    
    const selectedEventsList = allEvents.filter(e => selectedEvents.has(e.uid));
    listEl.innerHTML = selectedEventsList.map(event => `
        <div style="padding: 0.5rem; border-bottom: 1px solid var(--border-color); font-size: 0.85rem;">
            <strong>${escapeHtml(event.title || 'Untitled')}</strong>
            <div style="color: var(--text-muted);">${formatDate(event.start_utc)}</div>
        </div>
    `).join('');
}

function clearSelection() {
    selectedEvents.clear();
    updateSelection();
    renderEvents();
}

function addToFeed() {
    document.getElementById('add-to-feed-modal').style.display = 'flex';
}

function closeAddToFeedModal() {
    document.getElementById('add-to-feed-modal').style.display = 'none';
}

async function confirmAddToFeed() {
    const feedId = document.getElementById('feed-select').value;
    if (!feedId) {
        showToast('Please select a feed', 'danger');
        return;
    }
    
    try {
        const feed = feeds.find(f => f.id === feedId);
        if (!feed) {
            showToast('Feed not found', 'danger');
            return;
        }
        
        // Add selected UIDs to feed
        const existingUIDs = feed.selected_events || [];
        const newUIDs = [...new Set([...existingUIDs, ...Array.from(selectedEvents)])];
        
        await API.put(`/api/feeds/${feedId}`, {
            ...feed,
            selected_events: newUIDs
        });
        
        showToast(`Added ${selectedEvents.size} event(s) to ${feed.name}`);
        closeAddToFeedModal();
        clearSelection();
    } catch (error) {
        console.error('Error adding to feed:', error);
        showToast('Failed to add events to feed', 'danger');
    }
}

async function runPipeline() {
    if (!confirm('Refresh all events from sources? This may take a few minutes.')) return;
    
    try {
        await API.post('/api/pipeline/run', {});
        showToast('Pipeline started. Reloading events in 30 seconds...', 'info');
        setTimeout(() => location.reload(), 30000);
    } catch (error) {
        console.error('Error running pipeline:', error);
        showToast('Failed to start pipeline', 'danger');
    }
}

function formatDate(dateStr) {
    if (!dateStr) return 'Unknown date';
    try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return dateStr;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load data on page load
loadData();
</script>
{% endblock %}
