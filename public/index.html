<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Northwoods Events • Debug Viewer</title>
<style>
  :root { --muted:#6b7280; --bg:#f9fafb; --card:#ffffff; --bd:#e5e7eb; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; background: var(--bg); }
  header { display:flex; gap:1rem; align-items: baseline; flex-wrap:wrap; }
  h1 { margin:0; font-size: clamp(20px, 3vw, 28px); }
  .pill { background:#eef; color:#113; padding:.25rem .5rem; border-radius:999px; font-size:.85rem; }
  .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: .75rem; }
  .card { background: var(--card); border:1px solid var(--bd); border-radius:12px; padding:1rem; }
  .muted { color: var(--muted); }
  #filters { display:flex; gap:.75rem; flex-wrap:wrap; margin:.5rem 0 1rem; }
  .toolbar { display:flex; gap:.5rem; align-items:center; margin:.5rem 0 1rem; }
  table { width:100%; border-collapse: collapse; background: var(--card); border:1px solid var(--bd); border-radius:12px; overflow:hidden; }
  thead th { background:#f3f4f6; text-align:left; font-weight:600; padding:.6rem .7rem; border-bottom:1px solid var(--bd); }
  tbody td { padding:.55rem .7rem; border-bottom:1px solid var(--bd); vertical-align: top; }
  tbody tr:hover { background:#f9fafb; }
  a { color:#1d4ed8; text-decoration: none; }
  a:hover { text-decoration: underline; }
  .nowrap { white-space: nowrap; }
</style>
</head>
<body>
<header>
  <h1>Northwoods Events – Parse Report</h1>
  <span id="summary" class="pill">Loading…</span>
</header>

<section>
  <h2>Sources</h2>
  <div id="sources" class="grid"></div>

  <h3>Show calendars</h3>
  <div class="toolbar">
    <button id="allOn">All on</button>
    <button id="allOff">All off</button>
    <span class="muted">Toggle sources to filter the table below.</span>
  </div>
  <div id="filters"></div>
</section>

<section>
  <h2>Events <span id="evcount" class="muted"></span></h2>
  <table id="evtTable">
    <thead>
      <tr>
        <th class="nowrap">Date (UTC)</th>
        <th>Title</th>
        <th>Location</th>
        <th>URL</th>
        <th>Calendar</th>
      </tr>
    </thead>
    <tbody id="evtBody">
      <tr><td colspan="5" class="muted">Loading…</td></tr>
    </tbody>
  </table>
</section>

<footer class="muted" style="margin-top:1rem">
  Viewer reads <code>report.json</code> generated by the build. Use the toggles to validate parsed data per calendar.
</footer>

<script>
(async function(){
  const res = await fetch('report.json', {cache:'no-store'});
  const data = await res.json();

  const sourcesDiv = document.getElementById('sources');
  const filters    = document.getElementById('filters');
  const summary    = document.getElementById('summary');
  const evcount    = document.getElementById('evcount');
  const tbody      = document.getElementById('evtBody');
  const allOnBtn   = document.getElementById('allOn');
  const allOffBtn  = document.getElementById('allOff');

  // Prefer full list if present; fall back to preview
  const events = Array.isArray(data.events) && data.events.length
    ? data.events
    : (Array.isArray(data.events_preview) ? data.events_preview : []);

  const sources = (data.source_logs || data.sources || []).map(s => ({
    name: s.name, type: s.type, url: s.url, count: s.count,
    ok: s.ok, error: s.error || "", diag: s.diag || {}
  }));

  summary.textContent = `OK: ${data.success ? 'yes' : 'no'} • total events: ${data.total_events}`;

  // Build source cards
  const names = [];
  sources.forEach(s => {
    names.push(s.name);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div><strong>${s.name}</strong> <span class="muted">[${s.type}]</span></div>
      <div class="muted">${s.url}</div>
      <div>count: <strong>${s.count}</strong> • status: <strong>${s.ok ? 'ok' : 'error'}</strong></div>
      ${s.error ? `<div class="muted">error: ${s.error}</div>` : ''}
      <details><summary>diagnostics</summary><pre>${JSON.stringify(s.diag, null, 2)}</pre></details>
    `;
    sourcesDiv.appendChild(card);
  });

  // Filters
  const state = {};
  names.forEach(n => state[n] = true);
  function renderFilters() {
    filters.innerHTML = '';
    names.forEach(n => {
      const id = 'f_' + btoa(n).replace(/=/g,'');
      const label = document.createElement('label');
      label.style.marginRight = '1rem';
      label.innerHTML = `<input type="checkbox" id="${id}" ${state[n] ? 'checked' : ''}> ${n}`;
      filters.appendChild(label);
      label.querySelector('input').addEventListener('change', e => {
        state[n] = e.target.checked;
        renderTable();
      });
    });
  }
  allOnBtn.onclick = () => { names.forEach(n => state[n] = true); renderFilters(); renderTable(); };
  allOffBtn.onclick = () => { names.forEach(n => state[n] = false); renderFilters(); renderTable(); };

  // Table
  function renderTable() {
    const active = new Set(Object.entries(state).filter(([k,v]) => v).map(([k]) => k));
    const filtered = events.filter(e => active.has(e.calendar || e.source));
    evcount.textContent = `(${filtered.length} shown)`;
    tbody.innerHTML = '';
    if (!filtered.length) {
      tbody.innerHTML = `<tr><td colspan="5" class="muted">No events match the current filter.</td></tr>`;
      return;
    }
    filtered.forEach(e => {
      const tr = document.createElement('tr');
      const dt = e.start_utc || '—';
      tr.innerHTML = `
        <td class="nowrap">${dt}</td>
        <td>${e.title || '(untitled)'}</td>
        <td>${e.location ? e.location : '<span class="muted">—</span>'}</td>
        <td>${e.url ? `<a href="${e.url}" target="_blank" rel="noopener">Open</a>` : '<span class="muted">—</span>'}</td>
        <td>${e.calendar || e.source || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  renderFilters();
  renderTable();
})();
</script>
</body>
</html>
