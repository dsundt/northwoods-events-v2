<!-- public/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Northwoods Events — Debug Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 16px; }
    .muted { color: #666; }
    .ok { color: #0b7300; }
    .bad { color: #b00020; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #fafafa; position: sticky; top: 0; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0 16px; }
    .pill { border: 1px solid #ccc; border-radius: 999px; padding: 4px 10px; cursor: pointer; }
    .pill.active { background: #222; color: #fff; border-color: #222; }
    .src { font-size: 12px; color: #555; }
    .grid { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
  </style>
</head>
<body>
  <h1>Northwoods Events — Debug Viewer</h1>
  <p class="muted">This page reads <code>report.json</code> produced by the workflow and lists parsed events. Use the source toggles to filter.</p>

  <div id="stats" class="muted">Loading…</div>

  <div class="controls" id="sourceToggles"></div>

  <div class="grid">
    <label>
      Search:
      <input id="searchBox" type="search" placeholder="title, location, url…" />
    </label>
    <div>
      <a href="./combined.ics">Download combined.ics</a>
      &nbsp;|&nbsp;
      <a href="./report.json">View report.json</a>
    </div>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width: 160px;">Date (UTC)</th>
        <th>Title</th>
        <th style="width: 22%;">Location</th>
        <th style="width: 28%;">URL</th>
        <th style="width: 16%;">Source</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <h2>Source Status</h2>
  <table id="srcTbl">
    <thead>
      <tr>
        <th>Source</th>
        <th>Type</th>
        <th>URL</th>
        <th>OK</th>
        <th>Count</th>
        <th>Error</th>
      </tr>
    </thead>
    <tbody id="srcBody"></tbody>
  </table>

  <script>
    const state = {
      raw: null,
      events: [],
      sources: [],
      activeSources: new Set(),
      q: ""
    };

    const $ = s => document.querySelector(s);
    const tbody = $("#tbody");
    const srcBody = $("#srcBody");
    const stats = $("#stats");
    const toggles = $("#sourceToggles");
    const searchBox = $("#searchBox");

    fetch("./report.json", { cache: "no-store" })
      .then(r => r.json())
      .then(data => {
        state.raw = data;
        // Prefer normalized_events; fall back to events_preview
        const ev = Array.isArray(data.normalized_events) ? data.normalized_events
                  : (Array.isArray(data.events_preview) ? data.events_preview : []);
        // Normalize fields defensively
        state.events = ev.map(e => ({
          start_utc: e.start_utc || "",
          end_utc: e.end_utc || "",
          title: e.title || "(untitled)",
          location: e.location || "",
          url: e.url || "",
          source: e.source || e.calendar || "Unknown",
          calendar: e.calendar || e.source || "Unknown"
        }));

        state.sources = Array.isArray(data.source_logs) ? data.source_logs : [];
        // If we have no events, still render source table so errors are visible
        renderSourceTable();

        // Default: enable all sources with ok==true, or all if none ok
        const okAny = state.sources.some(s => s.ok);
        const toEnable = okAny ? state.sources.map(s => s.ok ? s.id || s.name : null).filter(Boolean)
                               : state.sources.map(s => s.id || s.name).filter(Boolean);
        toEnable.forEach(id => state.activeSources.add(id));
        renderToggles();
        renderTable();

        stats.textContent =
          `sources: ${state.sources.length}, events: ${state.events.length}, showing: ${visible().length}`;
      })
      .catch(err => {
        stats.innerHTML = `<span class="bad">Failed to load report.json: ${String(err)}</span>`;
      });

    function visible() {
      const q = state.q.trim().toLowerCase();
      return state.events.filter(e => {
        const id = findSourceId(e);
        const passSrc = state.activeSources.size === 0 || state.activeSources.has(id);
        if (!passSrc) return false;
        if (!q) return true;
        const hay = `${e.title} ${e.location} ${e.url} ${e.source}`.toLowerCase();
        return hay.includes(q);
      });
    }

    function findSourceId(e) {
      // Map by exact log name to id if present
      const s = state.sources.find(s => s.name === (e.source || e.calendar));
      return (s && (s.id || s.name)) || (e.source || e.calendar);
    }

    function renderTable() {
      const rows = visible()
        .sort((a,b) => String(a.start_utc).localeCompare(String(b.start_utc)))
        .map(e => `
          <tr>
            <td>${escapeHtml(e.start_utc || "")}</td>
            <td>${escapeHtml(e.title)}</td>
            <td>${escapeHtml(e.location || "")}</td>
            <td>${e.url ? `<a href="${escapeAttr(e.url)}" target="_blank" rel="noopener">link</a>` : ""}</td>
            <td class="src">${escapeHtml(e.source || e.calendar || "")}</td>
          </tr>
        `).join("");
      tbody.innerHTML = rows || `<tr><td colspan="5" class="muted">No events to display.</td></tr>`;
    }

    function renderSourceTable() {
      const rows = state.sources.map(s => `
        <tr>
          <td>${escapeHtml(s.name || s.id)}</td>
          <td>${escapeHtml(s.type || "")}</td>
          <td>${s.url ? `<a href="${escapeAttr(s.url)}" target="_blank" rel="noopener">open</a>` : ""}</td>
          <td class="${s.ok ? 'ok' : 'bad'}">${s.ok ? "yes" : "no"}</td>
          <td>${s.count ?? 0}</td>
          <td>${escapeHtml(s.error || "")}</td>
        </tr>
      `).join("");
      srcBody.innerHTML = rows || `<tr><td colspan="6" class="muted">No sources recorded.</td></tr>`;
    }

    function renderToggles() {
      toggles.innerHTML = "";
      state.sources.forEach(s => {
        const id = s.id || s.name;
        const btn = document.createElement("button");
        btn.className = "pill" + (state.activeSources.has(id) ? " active" : "");
        btn.textContent = s.name || id;
        btn.onclick = () => {
          if (state.activeSources.has(id)) state.activeSources.delete(id);
          else state.activeSources.add(id);
          btn.classList.toggle("active");
          renderTable();
        };
        toggles.appendChild(btn);
      });

      if (!state.sources.length) {
        const p = document.createElement("span");
        p.className = "muted";
        p.textContent = "No source logs found in report.json";
        toggles.appendChild(p);
      }
    }

    searchBox.addEventListener("input", () => {
      state.q = searchBox.value || "";
      renderTable();
    });

    function escapeHtml(s) {
      return (s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
      }[c]));
    }
    function escapeAttr(s) {
      return (s ?? "").replace(/"/g, "&quot;");
    }
  </script>
</body>
</html>
