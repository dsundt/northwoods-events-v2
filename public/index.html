<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Northwoods Events – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; background: #fafafa; }
    header { margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: baseline; }
    h1 { font-size: 1.4rem; margin: 0; }
    .controls { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    select, input[type="search"] { padding: 0.35rem 0.5rem; font-size: 0.95rem; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin: 1rem 0; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    h2 { font-size: 1.1rem; margin: 0 0 0.5rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 0.5rem; }
    th, td { border: 1px solid #ccc; padding: 0.4rem 0.6rem; text-align: left; font-size: 0.9rem; }
    th { background: #f5f5f5; }
    code { background: #f3f3f3; padding: 0.15rem 0.35rem; border-radius: 4px; }
    .ok { color: #0a7a0a; font-weight: 600; }
    .err { color: #a30008; font-weight: 600; }
    .muted { color: #666; }
    .row-actions a { margin-right: 0.5rem; }
  </style>
</head>
<body>
  <header>
    <h1>Northwoods Events – Dashboard</h1>
    <div class="controls">
      <label for="sourcePick"><strong>Source:</strong></label>
      <select id="sourcePick">
        <option value="__combined__">All (Combined)</option>
      </select>
      <input id="q" type="search" placeholder="Filter events by text…" aria-label="Filter">
      <span class="muted">Tip: choose a source to review individually.</span>
    </div>
  </header>

  <div id="status" class="card">Loading report…</div>

  <div class="card">
    <h2>Downloads</h2>
    <ul>
      <li><a href="combined.ics">combined.ics</a> (all events)</li>
      <li><a href="report.json">report.json</a> (raw report)</li>
      <li>Per-source ICS files are under <code>/by-source/</code>.</li>
    </ul>
  </div>

  <div id="sources" class="card"></div>
  <div id="events" class="card"></div>

  <script>
    const sel = document.getElementById('sourcePick');
    const q = document.getElementById('q');
    let REPORT = null;
    let SOURCES = []; // [{name, slug, type, count, ok, error}]
    let EVENTS = [];  // preview (all)
    let SLUGS = {};   // name -> slug derived from report logs

    function slugify(name) {
      return (name || 'source').toLowerCase().replace(/&/g,'and').replace(/[^a-z0-9\- ]/g,'-').trim().replace(/\s+/g,'-').replace(/-+/g,'-');
    }

    function renderStatus() {
      const s = document.getElementById('status');
      if (!REPORT) {
        s.innerHTML = '<p>Loading…</p>';
        return;
      }
      const ok = REPORT.success === true;
      s.innerHTML = `
        <p>Run time (UTC): <strong>${REPORT.run_started_utc || ''}</strong></p>
        <p>Success: <strong class="${ok ? 'ok' : 'err'}">${ok}</strong></p>
        <p>Total events: <strong>${REPORT.total_events}</strong></p>
        <p>Sources processed: <strong>${REPORT.sources_processed}</strong></p>
      `;
    }

    function renderSources() {
      const box = document.getElementById('sources');
      const logs = REPORT?.source_logs || [];
      if (!logs.length) {
        box.innerHTML = '<h2>Source Results</h2><p class="muted">No sources found.</p>';
        return;
      }
      // Build SOURCES + SLUGS
      SOURCES = logs.map(l => {
        const s = slugify(l.name) + "-" + (String(l.type||'').replace(/_/g,'-') || 'type');
        SLUGS[l.name] = s;
        return { name: l.name, slug: s, type: l.type, count: l.count, ok: !!l.ok, error: l.error || "", diag: l.diag || {} };
      });

      // Populate selector if empty
      if (sel.options.length <= 1) {
        for (const s of SOURCES) {
          const o = document.createElement('option');
          o.value = s.name;
          o.textContent = s.name;
          sel.appendChild(o);
        }
      }

      const rows = SOURCES.map(s => `
        <tr>
          <td>${s.name}</td>
          <td><code>${s.type}</code></td>
          <td>${s.count}</td>
          <td class="${s.ok ? 'ok':'err'}">${s.ok}</td>
          <td>${s.error ? `<code>${s.error}</code>` : ''}</td>
          <td class="row-actions">
            <a href="by-source/${SLUGS[s.name]}.ics" target="_blank">ICS</a>
            ${s.diag && s.diag.api_url ? `<a href="${s.diag.api_url}" target="_blank" rel="noopener">API URL</a>` : ''}
          </td>
        </tr>
      `).join('');

      box.innerHTML = `
        <h2>Source Results</h2>
        <table>
          <thead><tr><th>Source</th><th>Type</th><th>Events</th><th>OK</th><th>Error</th><th>Links</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function renderEvents() {
      const box = document.getElementById('events');
      const choice = sel.value; // '__combined__' or source name
      const query = (q.value || '').trim().toLowerCase();

      let items = REPORT?.events_preview || [];
      if (choice !== '__combined__') {
        items = items.filter(e => (e.source || '') === choice);
      }
      if (query) {
        items = items.filter(e => {
          const hay = [e.title, e.location, e.url, e.source].map(x => (x||'').toLowerCase()).join(' ');
          return hay.includes(query);
        });
      }

      const rows = items.map(e => `
        <tr>
          <td>${e.title || ''}</td>
          <td><code>${e.start_utc || ''}</code></td>
          <td>${e.source || ''}</td>
          <td>${e.url ? `<a href="${e.url}" target="_blank" rel="noopener">link</a>` : ''}</td>
          <td>${e.location || ''}</td>
        </tr>
      `).join('');

      box.innerHTML = `
        <h2>Events Preview ${choice === '__combined__' ? '(All Sources)' : `(${choice})`}</h2>
        <p class="muted">Showing up to ${REPORT?.events_preview_count || 0} events from <code>report.json</code>. Use the selector above to view a single calendar, or "All (Combined)".</p>
        <table>
          <thead><tr><th>Title</th><th>Start (UTC)</th><th>Source</th><th>URL</th><th>Location</th></tr></thead>
          <tbody>${rows || '<tr><td colspan="5" class="muted">No events in preview.</td></tr>'}</tbody>
        </table>
      `;
    }

    sel.addEventListener('change', renderEvents);
    q.addEventListener('input', renderEvents);

    fetch('report.json', { cache: 'no-store' })
      .then(r => r.ok ? r.json() : null)
      .then(j => {
        REPORT = j;
        renderStatus();
        renderSources();
        renderEvents();
      })
      .catch(() => {
        const s = document.getElementById('status');
        s.innerHTML = '<p class="err">Failed to load report.json.</p>';
      });
  </script>
</body>
</html>
