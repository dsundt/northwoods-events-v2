<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Northwoods Events v2 — Debug Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 1rem 1rem 3rem; }
    h1 { margin: 0.2rem 0 0.5rem; }
    .row { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
    label { font-weight: 600; }
    select, input[type="search"] { padding: 0.4rem 0.5rem; font-size: 0.95rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 0.75rem; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 0.5rem 0.6rem; text-align: left; vertical-align: top; }
    th { background: #f9fafb; position: sticky; top: 0; }
    .muted { color: #6b7280; }
    .badge { display:inline-block; font-size:.75rem; background:#eef2ff; color:#3730a3; padding:.15rem .4rem; border-radius:.4rem; }
    .err { color: #b91c1c; font-weight: 600; }
    .ok { color: #065f46; }
    .src { margin:.3rem 0 .6rem; }
    .wrap { word-break: break-word; }
  </style>
</head>
<body>
  <h1>Northwoods Events v2 — Build Output</h1>

  <div id="meta" class="muted"></div>

  <div class="row">
    <label for="calendarFilter">Calendar:</label>
    <select id="calendarFilter">
      <option value="">All calendars</option>
    </select>
    <label for="q">Search:</label>
    <input id="q" type="search" placeholder="Filter by title/location/url…"/>
  </div>

  <div id="sources"></div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width:12rem">Date</th>
        <th>Title</th>
        <th style="width:28%">Location</th>
        <th style="width:28%">URL</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const byCal = new Map();
    let all = [];

    function row(e){
      const tr = document.createElement('tr');
      const date = e.start_utc || '';
      const title = e.title || '';
      const loc = e.location || '';
      const url = e.url || '';
      tr.innerHTML = `
        <td class="wrap">${date}</td>
        <td class="wrap">${title}</td>
        <td class="wrap">${loc}</td>
        <td class="wrap">${url ? `<a href="${url}" target="_blank" rel="noopener">${url}</a>` : ''}</td>
      `;
      return tr;
    }

    function rebuild(){
      const cal = document.getElementById('calendarFilter').value;
      const q = document.getElementById('q').value.toLowerCase();
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      let list = cal ? (byCal.get(cal) || []) : all;
      if(q){
        list = list.filter(e => (e.title||'').toLowerCase().includes(q)
          || (e.location||'').toLowerCase().includes(q)
          || (e.url||'').toLowerCase().includes(q));
      }
      list.sort((a,b) => (a.start_utc||'').localeCompare(b.start_utc||''));
      list.forEach(e => tbody.appendChild(row(e)));
    }

    function badge(ok, text){
      return `<span class="badge" style="background:${ok?'#ecfdf5':'#fef2f2'};color:${ok?'#065f46':'#991b1b'}">${text}</span>`;
    }

    function renderSources(srcLogs){
      const c = document.getElementById('sources');
      c.innerHTML = srcLogs.map(s => {
        const ok = s.ok && !s.error;
        return `<div class="src">
          ${badge(ok, ok? 'ok' : 'error')}
          <strong>${s.name}</strong> <span class="muted">(${s.type})</span>
          — <span>${s.count} events</span>
          ${s.error ? `<div class="err">${s.error}</div>` : ''}
        </div>`;
      }).join('');
    }

    async function boot(){
      let report;
      try {
        // cache-bust to avoid stale GitHub Pages CDN
        const r = await fetch(`report.json?ts=${Date.now()}`, {cache:'no-store'});
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        report = await r.json();
      } catch(err){
        document.getElementById('meta').innerHTML = `<span class="err">Failed to load report.json: ${err}</span>`;
        return;
      }

      const srcLogs = report.source_logs || [];
      renderSources(srcLogs);

      // Prefer full normalized list if present; otherwise preview keys used by older runs
      let ev = report.events || report.events_preview || report.normalized || report.data || [];
      if(!Array.isArray(ev)) ev = [];

      // Populate calendar filter
      const sel = document.getElementById('calendarFilter');
      const calendars = Array.from(new Set(ev.map(e => e.calendar || e.source || 'Unknown'))).sort();
      calendars.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        sel.appendChild(opt);
      });
      sel.addEventListener('change', rebuild);
      document.getElementById('q').addEventListener('input', rebuild);

      all = ev.map(e => ({
        start_utc: e.start_utc || '', title: e.title || '',
        location: e.location || '', url: e.url || '',
        calendar: e.calendar || e.source || 'Unknown'
      }));
      byCal.clear();
      all.forEach(e => {
        const key = e.calendar || 'Unknown';
        if(!byCal.has(key)) byCal.set(key, []);
        byCal.get(key).push(e);
      });

      const meta = document.getElementById('meta');
      meta.innerHTML = `
        Build started: <strong>${report.run_started_utc || 'n/a'}</strong> —
        Sources: <strong>${report.sources_processed ?? srcLogs.length}</strong> —
        Events (in this file): <strong>${all.length}</strong>
      `;

      rebuild();
    }
    boot();
  </script>
</body>
</html>
