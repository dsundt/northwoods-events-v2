<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Northwoods Events • Debug Viewer</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 1rem; }
  header { display:flex; gap:1rem; align-items: baseline; flex-wrap: wrap; }
  .pill { background:#eef; color:#113; padding:.25rem .5rem; border-radius:999px; font-size:.85rem; }
  #filters { display:flex; gap:.75rem; flex-wrap: wrap; margin:.5rem 0 1rem; }
  .card { border:1px solid #ddd; border-radius:12px; padding:1rem; margin:.5rem 0; }
  .when { font: 600 .9rem/1.3 system-ui; color:#333; }
  .title { font: 600 1.05rem/1.3 system-ui; margin:.25rem 0; }
  .src { color:#555; font-size:.85rem; }
  .loc, .url { color:#333; font-size:.9rem; }
  .muted { color:#777; }
  details { margin:.5rem 0 1rem; }
  code { background:#f6f6f6; padding:.25rem .35rem; border-radius:6px; }
  footer { margin:2rem 0 1rem; color:#666; font-size:.85rem; }
  .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: .75rem; }
</style>
</head>
<body>
<header>
  <h1>Northwoods Events – Parse Report</h1>
  <span id="summary" class="pill">Loading…</span>
</header>

<section>
  <h2>Sources</h2>
  <div id="sources" class="grid"></div>

  <h3>Show calendars</h3>
  <div id="filters"></div>
</section>

<section>
  <h2>Events <span id="evcount" class="muted"></span></h2>
  <div id="events"></div>
</section>

<footer>
  Viewer reads <code>report.json</code> generated by the build. Toggle sources above to verify parsed data.
</footer>

<script>
(async function(){
  const res = await fetch('report.json', {cache:'no-store'});
  const data = await res.json();

  const sourcesDiv = document.getElementById('sources');
  const eventsDiv  = document.getElementById('events');
  const filters    = document.getElementById('filters');
  const summary    = document.getElementById('summary');
  const evcount    = document.getElementById('evcount');

  const sources = (data.sources || []).map(s => ({
    name: s.name, type: s.type, url: s.url, count: s.count,
    ok: s.ok, error: s.error || "", diag: s.diag || {}
  }));

  summary.textContent = `OK: ${data.ok ? 'yes' : 'no'} • total events: ${data.total_events}`;

  // Source cards + filters
  const byName = {};
  sources.forEach(s => {
    byName[s.name] = s;

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div><strong>${s.name}</strong> <span class="muted">[${s.type}]</span></div>
      <div class="muted">${s.url}</div>
      <div>count: <strong>${s.count}</strong> • status: <strong>${s.ok ? 'ok' : 'error'}</strong></div>
      ${s.error ? `<div class="muted">error: ${s.error}</div>` : ''}
      <details><summary>diagnostics</summary><pre>${JSON.stringify(s.diag, null, 2)}</pre></details>
    `;
    sourcesDiv.appendChild(card);

    // filter checkbox
    const id = 'f_' + btoa(s.name).replace(/=/g,'');
    const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" id="${id}" checked> ${s.name}`;
    filters.appendChild(label);
    label.style.marginRight = '1rem';

    label.querySelector('input').addEventListener('change', render);
  });

  const events = (data.sample || data.events || []).length ? (data.sample || []) : [];
  // If writer used "sample", we only preview; that’s enough to verify parsing.
  // If you later put full events list into report.json (e.g. under "events"), this viewer will use it automatically.

  function render(){
    const active = new Set(
      [...filters.querySelectorAll('input[type=checkbox]')]
      .filter(cb => cb.checked)
      .map(cb => cb.nextSibling.textContent.trim())
    );
    eventsDiv.innerHTML = '';
    const filtered = events.filter(e => active.has(e.calendar));
    evcount.textContent = `(${filtered.length} shown)`;
    if(!filtered.length){
      eventsDiv.innerHTML = `<p class="muted">No events match the current filter.</p>`;
      return;
    }
    filtered.forEach(e => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="when">${e.start_utc || '—'} ${e.end_utc ? ' → ' + e.end_utc : ''}</div>
        <div class="title">${e.title || '(untitled)'}</div>
        <div class="src">${e.calendar}</div>
        <div class="loc">${e.location ? e.location : '<span class="muted">no location</span>'}</div>
        <div class="url">${e.url ? `<a href="${e.url}" target="_blank" rel="noopener">Open</a>` : '<span class="muted">no url</span>'}</div>
      `;
      eventsDiv.appendChild(card);
    });
  }

  render();
})();
</script>
</body>
</html>
